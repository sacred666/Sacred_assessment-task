import preferences from '@ohos.data.preferences';
import common from '@ohos.app.ability.common';

export class LoginStateManager {
  private static readonly PREF_NAME = 'my_app_prefs';
  private static readonly KEY_LOGIN = 'is_logged_in';
  private static context: common.UIAbilityContext;

  // 【关键】接收 EntryAbility 传过来的 Context
  static setContext(context: common.UIAbilityContext) {
    LoginStateManager.context = context;
  }

  // 执行登录
  static async login() {
    if (!LoginStateManager.context) return;
    try {
      const pref = await preferences.getPreferences(LoginStateManager.context, LoginStateManager.PREF_NAME);
      await pref.put(LoginStateManager.KEY_LOGIN, true);
      await pref.flush();
      // 更新全局状态，通知 UI 刷新
      AppStorage.SetOrCreate('isLoggedIn', true);
    } catch (err) {
      console.error('Login failed:', err);
    }
  }

  // 退出登录
  static async logout() {
    if (!LoginStateManager.context) return;
    try {
      const pref = await preferences.getPreferences(LoginStateManager.context, LoginStateManager.PREF_NAME);
      await pref.put(LoginStateManager.KEY_LOGIN, false);
      await pref.flush();
      AppStorage.SetOrCreate('isLoggedIn', false);
    } catch (err) {
      console.error('Logout failed:', err);
    }
  }

  // 初始化状态
  static async initLoginStatus() {
    if (!LoginStateManager.context) {
      AppStorage.SetOrCreate('isLoggedIn', false);
      return;
    }
    try {
      const pref = await preferences.getPreferences(LoginStateManager.context, LoginStateManager.PREF_NAME);
      const isLogin = await pref.get(LoginStateManager.KEY_LOGIN, false);
      AppStorage.SetOrCreate('isLoggedIn', isLogin);
    } catch (err) {
      AppStorage.SetOrCreate('isLoggedIn', false);
    }
  }

  // 获取当前状态
  static isLoggedIn(): boolean {
    return AppStorage.Get('isLoggedIn') || false;
  }
}

import { AppStorageV2 } from "@kit.ArkUI";
import { LoginStateManager } from "../utils/LoginStateManager";
import { Mine1 } from "./Mine1";
import { Mine } from "./Mine";
// 引入其他页面 (Find, HomePage, Movie, Vip 保持你原有的引用)
import { Find } from "./Find";
import { HomePage } from "./HomePage";
import { Movie } from "./Movie";
import { Vip } from "./Vip";

interface TabClass { text: string; icon: ResourceStr; }

// 【必须导出这个 Builder】，名字要和 route_map.json 里的一致
@Builder
export function LayoutsBuilder() {
  Layouts();
}

@Component
export struct Layouts {
  @State currentindex: number = 0;
  @StorageLink('isLoggedIn') isLoggedIn: boolean = false;

  // 连接全局栈 (虽然 Layouts 自己不跳，但保持连接是个好习惯)
  pathStack: NavPathStack = AppStorageV2.connect(NavPathStack, 'navStack')!;

  private tabData: TabClass[] = [
    {text: '首页', icon: $r('app.media.home')},
    {text: '影院·场馆', icon: $r('app.media.movie')},
    {text: '大麦VIP', icon: $r('app.media.vip')},
    {text: '发现', icon: $r('app.media.refind')},
    {text: '我的', icon: $r('app.media.mine')}
  ];

  @Builder
  private tabbuilder(item: TabClass, index: number) {
    Column({space: 5}) {
      Image(item.icon)
        .width(24)
        .fillColor(this.currentindex == index ? "#FF7F24" : "#000000");
      Text(item.text)
        .fontSize(14)
        .fontColor(this.currentindex == index ? "#FF7F24" : "#000000");
    }
  }

  aboutToAppear(): void {
    LoginStateManager.initLoginStatus();
  }

  build() {
    // 【必须包裹 NavDestination】，因为它是从 Ad 页面 replace 过来的
    NavDestination() {
      Tabs({barPosition: BarPosition.End}) {
        ForEach(this.tabData, (item: TabClass, index: number) => {
          TabContent() {
            if (index === 0) HomePage();
            else if (index === 1) Movie();
            else if (index === 2) Vip();
            else if (index === 3) Find();
            else if (index === 4) {
              // 登录状态切换
              if (this.isLoggedIn) {
                Mine();
              } else {
                Mine1();
              }
            }
          }
          .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
          .tabBar(this.tabbuilder(item, index))
          .backgroundColor("#fff");
        });
      }
      .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
      .backgroundColor("#fff")
      .onChange((index: number) => {
        this.currentindex = index;
      });
    }
    .hideTitleBar(true) // 隐藏系统标题栏
  }
}

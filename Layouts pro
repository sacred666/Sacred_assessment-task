// pages/Layouts.ets
import { TabBarPosition, AppStorageV2 } from "@kit.ArkUI";
import { Find } from "./Find";
import { HomePage } from "./HomePage";
import { Movie } from "./Movie";
import { Vip } from "./Vip";
import { LoginStateManager } from "../utils/LoginStateManager";
import { Mine1 } from "./Mine1";
import { Mine } from "./Mine";

interface TabClass {
  text: string;
  icon: ResourceStr;
}

@Builder
export function LayoutsBuilder() {
  Layouts();
}

@Component
struct Layouts {
  @State currentindex: number = 0;
  @StorageLink('isLoggedIn') isLoggedIn: boolean = false;
  private pathStack: NavPathStack = new NavPathStack();

  private tabData: TabClass[] = [
    {text: '首页', icon: $r('app.media.home')},
    {text: '影院·场馆', icon: $r('app.media.movie')},
    {text: '大麦VIP', icon: $r('app.media.vip')},
    {text: '发现', icon: $r('app.media.refind')},
    {text: '我的', icon: $r('app.media.mine')}
  ];

  @Builder
  private tabbuilder(item: TabClass, index: number) {
    Column({space: 5}) {
      Image(item.icon)
        .width(24)
        .fillColor(this.currentindex == index ? "#FF7F24" : "#000000");

      Text(item.text)
        .fontSize(14)
        .fontColor(this.currentindex == index ? "#FF7F24" : "#000000");
    }
  }

  aboutToAppear(): void {
    // 初始化AppStorage键
    AppStorage.setOrCreate<boolean>('isLoggedIn', false);
    // 从Preferences初始化登录状态
    LoginStateManager.initLoginStatus();
  }

  build() {
    NavDestination() {
      Tabs({barPosition: BarPosition.End}) {
        ForEach(this.tabData, (item: TabClass, index: number) => {
          TabContent() {
            if (index === 0) {
              HomePage();
            } else if (index === 1) {
              Movie();
            } else if (index === 2) {
              Vip();
            } else if (index === 3) {
              Find();
            } else if (index === 4) {
              // 根据登录状态显示不同的"我的"页面
              if (this.isLoggedIn) {
                Mine();
              } else {
                Mine1();
              }
            }
          }
          .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
          .tabBar(this.tabbuilder(item, index))
          .backgroundColor("#fff");
        });
      }
      .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
      .backgroundColor("#fff")
      .onChange((index: number) => {
        this.currentindex = index;
        // 每次切换到"我的"标签时，重新检查登录状态
        if (index === 4) {
          this.isLoggedIn = LoginStateManager.isLoggedIn();
        }
      });
    }
    .onReady((context: NavDestinationContext) => {
      this.pathStack = context.pathStack;
    });
  }
}

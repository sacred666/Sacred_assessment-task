import { AppStorageV2 } from "@kit.ArkUI";
import { preferences } from '@kit.ArkData';
import { common } from "@kit.AbilityKit";

// 跳转页面入口函数
@Builder
export function SearchsBuilder() {
  Searchs()
}

@Component
@Entry
struct Searchs {
  @State historylist: string[] = []
  @State keywords: string = ""
  pathStack: NavPathStack = new NavPathStack();
  private prefs: preferences.Preferences | null = null;

  async aboutToAppear() {
    // 初始化Preferences
    try {
      const context = getContext(this) as common.UIAbilityContext;
      this.prefs = await preferences.getPreferences(context, 'search_history');
      // 从Preferences加载搜索历史
      const storedHistory: string = await this.prefs.get('history', '[]') as string;
      const parsedHistory: string[] = JSON.parse(storedHistory) as string[];
      if (Array.isArray(parsedHistory)) {
        this.historylist = parsedHistory;
      }
    } catch (error) {
      console.error('Failed to load search history:', error);
    }
  }

  // 保存搜索历史到Preferences
  async saveSearchHistory(): Promise<void> {
    if (!this.prefs) {
      return;
    }
    try {
      await this.prefs.put('history', JSON.stringify(this.historylist));
      await this.prefs.flush();
    } catch (error) {
      console.error('Failed to save search history:', error);
    }
  }

  // 添加搜索记录
  async addSearchHistory(keyword: string): Promise<void> {
    if (!keyword.trim()) {
      return;
    }

    // 创建新的数组以避免直接修改原数组
    let newHistory: string[] = [...this.historylist];

    // 避免重复记录
    const index: number = newHistory.indexOf(keyword);
    if (index !== -1) {
      newHistory.splice(index, 1);
    }

    // 添加到开头
    newHistory.unshift(keyword);

    // 限制历史记录数量
    if (newHistory.length > 50) {
      newHistory = newHistory.slice(0, 50);
    }

    // 更新状态
    this.historylist = newHistory;

    // 保存到Preferences
    await this.saveSearchHistory();
  }

  // 清空搜索历史
  async clearSearchHistory(): Promise<void> {
    this.historylist = [];
    await this.saveSearchHistory();
  }

  build() {
    NavDestination() {
      Column() {
        Row() {
          Row() {
            Image($r("app.media.search"))
              .padding({ left: 10 })
              .width(30)
            TextInput({
              placeholder: ("2025 卓沅【KEY'S KEYS】巡回演唱会"),
              text: $$this.keywords
            })
              .placeholderColor('#817D83')
              .onSubmit(async () => {
                if (this.keywords.trim()) {
                  await this.addSearchHistory(this.keywords);
                  this.keywords = "";
                }
              })
              .fontColor('#151515')
              .layoutWeight(1)
              .backgroundColor("#f8ebfa")
              .margin({ right: 6 })
          }
          .layoutWeight(1)
          .backgroundColor("#f8ebfa")
          .border({ radius: 20 })
          Text("取消")
            .fontSize(20)
            .margin({ left: 10 })
            .backgroundColor(Color.White)
            .onClick(() => { this.pathStack.pop() })
        }
        .margin({ bottom: 30 })
        .width("100%")
        //历史搜索区域
        Row() {
          Text("搜索历史")
            .fontSize(20)
            .layoutWeight(1)
          Image($r("app.media.delete"))
            .width(20)
            .onClick(async () => {
              await this.clearSearchHistory();
            })
        }
        .margin({ bottom: 20 })
        .width("100%")
        //历史记录
        Flex({ wrap: FlexWrap.Wrap }) {
          ForEach(this.historylist, (item: string) => {
            Text(item)
              .backgroundColor("#f6f6f6")
              .padding({ left: 7, right: 7, top: 5, bottom: 5 })
              .border({ radius: 20 })
              .margin({ right: 15, bottom: 15 })
          }, (item: string) => item)
        }
        //Flex满行自动换行
      }
      .width("100%")
      .height("100%")
      .backgroundColor(Color.White)
      .padding({ right: 20, left: 20, bottom: 20 })
      .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
    }
    .onReady((context: NavDestinationContext) => {
      this.pathStack = context.pathStack;
    })
    .hideTitleBar(true)  // 隐藏标题栏
  }
}
